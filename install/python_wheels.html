<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Building Python Wheels &mdash; NEURON  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=6933245a" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/design-tabs.js?v=36754332"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Windows build" href="windows.html" />
    <link rel="prev" title="Mac Binary Package (Apple M1 and Mac x86_64)" href="mac_pkg.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            NEURON
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Building:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmake_doc/index.html">CMake Build Options</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer.html">Developer Builds</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mac_pkg.html">Mac Binary Package (Apple M1 and Mac x86_64)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Building Python Wheels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#linux-wheels">Linux wheels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-docker">Setting up Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#neuron-docker-image-workflow">NEURON Docker Image Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-docker-images-automatically">Building the docker images automatically</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-docker-image-manually">Building the docker image manually</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pushing-to-dockerhub">Pushing to DockerHub</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-the-docker-image">Using the docker image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mpi-support">MPI support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#macos-wheels">macOS wheels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#installing-macos-prerequisites">Installing macOS prerequisites</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#launch-the-wheel-building">Launch the wheel building</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#linux">Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="#macos">macOS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing-the-wheels">Testing the wheels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#macos-considerations">MacOS considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-on-bb5">Testing on BB5</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#publishing-the-wheels-on-pypi-via-azure">Publishing the wheels on Pypi via Azure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#variables-that-drive-pypi-upload">Variables that drive PyPI upload</a></li>
<li class="toctree-l4"><a class="reference internal" href="#release-wheels">Release wheels</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#publishing-the-wheels-on-pypi-via-circleci">Publishing the wheels on Pypi via CircleCI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nightly-wheels">Nightly wheels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-test-azure-wheels-locally">How to test Azure wheels locally</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="windows.html">Windows build</a></li>
<li class="toctree-l2"><a class="reference internal" href="formatting.html">Code Formatting</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_coverage.html">Code Coverage</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html">Diagnosis and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html#profiling-and-performance-benchmarking">Profiling and performance benchmarking</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../videos/index.html">Training videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../courses/exercises2018.html">NEURON Course Exercises</a></li>
<li class="toctree-l1"><a class="reference external" href="https://neuron.yale.edu/phpBB">The NEURON forum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications about NEURON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications-using-neuron.html">Publications using NEURON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NEURON scripting:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scripting.html">Running Python and HOC scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">NEURON Python documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hoc/index.html">NEURON HOC documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otherscripting.html">Other scripting languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Python tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rxd-tutorials/index.html">Python RXD tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coreneuron/index.html">CoreNEURON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NMODLanguage:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nmodl/index.html">NMODLanguage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scm/index.html">NEURON SCM and Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">NEURON Development topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">C/C++ API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Removed Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../removed_features.html">Removed Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">NEURON 8.2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#neuron-8-1">NEURON 8.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#neuron-8-0">NEURON 8.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#contributors">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#feedback-help">Feedback / Help</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NEURON</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="developer.html">Developer Builds</a></li>
      <li class="breadcrumb-item active">Building Python Wheels</li>
<li class="wy-breadcrumbs-aside">
    
    
</li>

      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/install/python_wheels.md.txt" rel="nofollow"> View page source</a>
      </li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="building-python-wheels">
<h1>Building Python Wheels<a class="headerlink" href="#building-python-wheels" title="Link to this heading"></a></h1>
<section id="linux-wheels">
<h2>Linux wheels<a class="headerlink" href="#linux-wheels" title="Link to this heading"></a></h2>
<p>In order to have NEURON binaries run on most Linux distros, we rely on the <a class="reference external" href="https://github.com/pypa/manylinux">manylinux project</a>.
Current NEURON Linux image is based on <code class="docutils literal notranslate"><span class="pre">manylinux2014</span></code>.</p>
<section id="setting-up-docker">
<h3>Setting up Docker<a class="headerlink" href="#setting-up-docker" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Docker_(software)">Docker</a> is required for building Linux wheels.
You can find instructions on how to setup Docker on Linux <a class="reference external" href="https://docs.docker.com/engine/install/">here</a>.</p>
</section>
<section id="neuron-docker-image-workflow">
<h3>NEURON Docker Image Workflow<a class="headerlink" href="#neuron-docker-image-workflow" title="Link to this heading"></a></h3>
<p>When required (i.e. update packages, add new software), <code class="docutils literal notranslate"><span class="pre">NEURON</span> <span class="pre">maintainers</span></code> are in charge of
updating the NEURON docker images published on Docker Hub under
<a class="reference external" href="https://hub.docker.com/r/neuronsimulator/neuron_wheel">neuronsimulator/neuron_wheel</a>.</p>
<p>Azure pipelines pull this image off DockerHub for Linux wheels building.</p>
<p>Updating and publishing the public images are done by a manual process that relies on a
<code class="docutils literal notranslate"><span class="pre">Docker</span> <span class="pre">file</span></code>  (see <a class="reference download internal" download="" href="../_downloads/3d1ca9dc4c69fce3254f0817b8117781/Dockerfile"><span class="xref download myst">packaging/python/Dockerfile</span></a>).
Any official update of these files shall imply a PR reviewed and merged before <code class="docutils literal notranslate"><span class="pre">DockerHub</span></code> publishing.</p>
<p>All wheels built on Azure are:</p>
<ul class="simple">
<li><p>Published to <code class="docutils literal notranslate"><span class="pre">Pypi.org</span></code> as</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">neuron-nightly</span></code> -&gt; when the pipeline is launched in CRON mode</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">neuron-x.y.z</span></code> -&gt; when the pipeline is manually triggered for release <code class="docutils literal notranslate"><span class="pre">x.y.z</span></code></p></li>
</ul>
</li>
<li><p>Stored as <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">artifacts</span></code> in the Azure pipeline for every run.</p></li>
</ul>
<p>Refer to the following image for the NEURON Docker Image workflow:
<img alt="" src="../_images/docker-workflow.png" /></p>
</section>
<section id="building-the-docker-images-automatically">
<h3>Building the docker images automatically<a class="headerlink" href="#building-the-docker-images-automatically" title="Link to this heading"></a></h3>
<p>If you run the workflow manually on Gitlab (with the “Run pipeline” button), it will now have the <code class="docutils literal notranslate"><span class="pre">mac_m1_container_build</span></code> and <code class="docutils literal notranslate"><span class="pre">x86_64_container_build</span></code> jobs added to it. These jobs need to be started manually and will not affect the overal workflow status. They don’t need to be run every time, just when a refresh of the container images is necessary.
They will build the container images and push to docker hub. If you want to, you can still build manually (see next section), but there shouldn’t be a requirement to do so any more.</p>
<p>A word of warning: podman on OSX uses a virtual machine. The job can take care of starting it, but we generally try to have it running to avoid jobs cleaning up after themselves and killing the machine for other jobs. When starting the machine, set the variables that need to be set during the container build, ie. proxy and <code class="docutils literal notranslate"><span class="pre">BUILDAH_FORMAT</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">BUILDAH_FORMAT</span></code> ensures that <code class="docutils literal notranslate"><span class="pre">ONBUILD</span></code> instructions are enabled.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">http_proxy</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">bbpproxy</span><span class="o">.</span><span class="n">epfl</span><span class="o">.</span><span class="n">ch</span><span class="p">:</span><span class="mi">80</span>
<span class="n">export</span> <span class="n">https_proxy</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">bbpproxy</span><span class="o">.</span><span class="n">epfl</span><span class="o">.</span><span class="n">ch</span><span class="p">:</span><span class="mi">80</span>
<span class="n">export</span> <span class="n">HTTP_PROXY</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">bbpproxy</span><span class="o">.</span><span class="n">epfl</span><span class="o">.</span><span class="n">ch</span><span class="p">:</span><span class="mi">80</span>
<span class="n">export</span> <span class="n">HTTPS_PROXY</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">bbpproxy</span><span class="o">.</span><span class="n">epfl</span><span class="o">.</span><span class="n">ch</span><span class="p">:</span><span class="mi">80</span>
<span class="n">export</span> <span class="n">BUILDAH_FORMAT</span><span class="o">=</span><span class="n">docker</span>
</pre></div>
</div>
</section>
<section id="building-the-docker-image-manually">
<h3>Building the docker image manually<a class="headerlink" href="#building-the-docker-image-manually" title="Link to this heading"></a></h3>
<p>After making updates to any of the docker files, you can build the image with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">nrn</span><span class="o">/</span><span class="n">packaging</span><span class="o">/</span><span class="n">python</span>
<span class="c1"># update Dockerfile</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">neuronsimulator</span><span class="o">/</span><span class="n">neuron_wheel</span><span class="p">:</span><span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span> <span class="o">.</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;tag&gt;</span></code> is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">latest-x86_64</span></code> or <code class="docutils literal notranslate"><span class="pre">latest-aarch64</span></code> for official publishing on respective platforms. For <code class="docutils literal notranslate"><span class="pre">master</span></code>, we are using <code class="docutils literal notranslate"><span class="pre">latest-gcc9-x86_64</span></code> and <code class="docutils literal notranslate"><span class="pre">latest-gcc9-aarch64</span></code> (see <a class="reference external" href="https://github.com/neuronsimulator/nrn/pull/1971">Use GCC9 for building wheels #1971</a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">feature-name</span></code> for updates (for local testing or for PR testing purposes where you can temporarily publish the tag on DockerHub and tweak Azure CI pipelines to use it - refer to
<code class="docutils literal notranslate"><span class="pre">Job:</span> <span class="pre">'ManyLinuxWheels'</span></code> in <a class="reference download internal" download="" href="../_downloads/d2bceaf44d8f483b0fb9aacd4f75aac4/azure-pipelines.yml"><span class="xref download myst">azure-pipelines.yml</span></a> )</p></li>
</ul>
<p>If you are building an image for AArch64 i.e. with <code class="docutils literal notranslate"><span class="pre">latest-aarch64</span></code> tag then you additionally pass <code class="docutils literal notranslate"><span class="pre">--build-arg</span></code> argument to docker build command in order to use compatible manylinux image for ARM64 platform (e.g. while building on Apple M1 or QEMU emulation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">neuronsimulator</span><span class="o">/</span><span class="n">neuron_wheel</span><span class="p">:</span><span class="n">latest</span><span class="o">-</span><span class="n">aarch64</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">arg</span> <span class="n">MANYLINUX_IMAGE</span><span class="o">=</span><span class="n">manylinux2014_aarch64</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile</span> <span class="o">.</span>
</pre></div>
</div>
</section>
<section id="pushing-to-dockerhub">
<h3>Pushing to DockerHub<a class="headerlink" href="#pushing-to-dockerhub" title="Link to this heading"></a></h3>
<p>In order to push the image and its tag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">login</span> <span class="o">--</span><span class="n">username</span><span class="o">=&lt;</span><span class="n">username</span><span class="o">&gt;</span>
<span class="n">docker</span> <span class="n">push</span> <span class="n">neuronsimulator</span><span class="o">/</span><span class="n">neuron_wheel</span><span class="p">:</span><span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="using-the-docker-image">
<h3>Using the docker image<a class="headerlink" href="#using-the-docker-image" title="Link to this heading"></a></h3>
<p>You can either build the neuron images locally or pull them from DockerHub:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker pull neuronsimulator/neuron_wheel:latest-x86_64
Using default tag: latest-x86_64
latest: Pulling from neuronsimulator/neuron_wheel
....
Status: Downloaded newer image for neuronsimulator/neuron_wheel:latest
docker.io/neuronsimulator/neuron_wheel:latest-x86_64
</pre></div>
</div>
<p>We can conveniently mount the local NEURON repository inside docker, by using the <code class="docutils literal notranslate"><span class="pre">-v</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -v $PWD/nrn:/root/nrn -w /root/nrn -it neuronsimulator/neuron_wheel:latest-x86_64 bash
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">$PWD/nrn</span></code> is a NEURON repository on the host machine that ends up mounted at <code class="docutils literal notranslate"><span class="pre">/root/nrn</span></code>.
This is how you can test your NEURON updates inside the NEURON Docker image.
Note that <code class="docutils literal notranslate"><span class="pre">-w</span></code> sets the working directory inside the container.</p>
</section>
<section id="mpi-support">
<h3>MPI support<a class="headerlink" href="#mpi-support" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">neuronsimulator/neuron_wheel</span></code> provides out-of-the-box support for <code class="docutils literal notranslate"><span class="pre">mpich</span></code> and <code class="docutils literal notranslate"><span class="pre">openmpi</span></code>.
For <code class="docutils literal notranslate"><span class="pre">HPE-MPT</span> <span class="pre">MPI</span></code>, since it’s not open source, you need to acquire the headers and mount them in the docker image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -v $PWD/nrn:/root/nrn -w /root/nrn -v $PWD/mpt-headers/2.21/include:/nrnwheel/mpt/include -it neuronsimulator/neuron_wheel:latest-x86_64 bash
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">$PWD/mpt-headers</span></code> is the path to the HPE-MPT MPI headers on the host machine that end up mounted at <code class="docutils literal notranslate"><span class="pre">/nrnwheel/mpt/include</span></code>.
You can download the headers with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">ssh</span><span class="p">:</span><span class="o">//</span><span class="n">bbpcode</span><span class="o">.</span><span class="n">epfl</span><span class="o">.</span><span class="n">ch</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">kumbhar</span><span class="o">/</span><span class="n">mpt</span><span class="o">-</span><span class="n">headers</span>
</pre></div>
</div>
</section>
</section>
<section id="macos-wheels">
<h2>macOS wheels<a class="headerlink" href="#macos-wheels" title="Link to this heading"></a></h2>
<p>Note that for macOS there is no docker image needed, but all required dependencies must exist.
In order to have the wheels working on multiple macOS target versions, special consideration must be made for <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET</span></code>.</p>
<p>Taking Azure macOS <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> wheels for example, <code class="docutils literal notranslate"><span class="pre">readline</span></code> was built with <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET=10.9</span></code> and stored as secure file on Azure (under <code class="docutils literal notranslate"><span class="pre">Pipelines</span> <span class="pre">&gt;</span> <span class="pre">Library</span> <span class="pre">&gt;</span> <span class="pre">Secure</span> <span class="pre">files</span></code>).
For <code class="docutils literal notranslate"><span class="pre">arm64</span></code> we need to set <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET=11.0</span></code>. The wheels currently need to be built manually, using <code class="docutils literal notranslate"><span class="pre">universal2</span></code> Python installers.
For upcoming <code class="docutils literal notranslate"><span class="pre">universal2</span></code> wheels (targeting both <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> and <code class="docutils literal notranslate"><span class="pre">arm64</span></code>) we will consider leveling everything to <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET=11.0</span></code>.</p>
<p>You can use <a class="reference download internal" download="" href="../_downloads/5cec11f68bddf0eff5a7d2c673b525fc/build_static_readline_osx.bash"><span class="xref download myst">packaging/python/build_static_readline_osx.bash</span></a> to build a static readline library.
You can have a look at the script for requirements and usage.</p>
<section id="installing-macos-prerequisites">
<h3>Installing macOS prerequisites<a class="headerlink" href="#installing-macos-prerequisites" title="Link to this heading"></a></h3>
<p>Install the necessary Python versions by downloading the universal2 installers from https://www.python.org/downloads/macos/
You’ll need several other packages installed as well (brew is fine):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">brew</span> <span class="n">install</span> <span class="o">--</span><span class="n">cask</span> <span class="n">xquartz</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">flex</span> <span class="n">bison</span> <span class="n">mpich</span> <span class="n">cmake</span>
<span class="n">brew</span> <span class="n">unlink</span> <span class="n">mpich</span> <span class="o">&amp;&amp;</span> <span class="n">brew</span> <span class="n">install</span> <span class="n">openmpi</span>
<span class="n">brew</span> <span class="n">uninstall</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">dependencies</span> <span class="n">libomp</span> <span class="o">||</span> <span class="n">echo</span> <span class="s2">&quot;libomp doesn&#39;t exist&quot;</span>
</pre></div>
</div>
<p>Bison and flex installed through brew will not be symlinked into /opt/homebrew (installing it next to the version provided by OSX can cause problems). To ensure the installed versions will actually be picked up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export BREW_PREFIX=$(brew --prefix)
export PATH=/opt/homebrew/opt/bison/bin:/opt/homebrew/opt/flex/bin:$PATH
</pre></div>
</div>
</section>
</section>
<section id="launch-the-wheel-building">
<h2>Launch the wheel building<a class="headerlink" href="#launch-the-wheel-building" title="Link to this heading"></a></h2>
<section id="linux">
<h3>Linux<a class="headerlink" href="#linux" title="Link to this heading"></a></h3>
<p>Once we’ve cloned and mounted NEURON inside Docker(c.f. <code class="docutils literal notranslate"><span class="pre">-v</span></code> option described previously), we can proceed with wheels building.
There is a build script which loops over available pythons in the Docker image under <code class="docutils literal notranslate"><span class="pre">/opt/python</span></code>, and then builds and audits the generated wheels.
Wheels are generated under <code class="docutils literal notranslate"><span class="pre">/root/nrn/wheelhouse</span></code> and also accessible in the mounted NEURON folder from outside the Docker image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Working directory is /root/nrn</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">linux</span>
<span class="n">ls</span> <span class="o">-</span><span class="n">la</span> <span class="n">wheelhouse</span>
</pre></div>
</div>
<p>You can build the wheel for a specific python version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">linux</span> <span class="mi">38</span>    <span class="c1"># 38 for Python v3.8</span>
</pre></div>
</div>
<p>To build wheels with CoreNEURON support you have to pass an additional argument: <code class="docutils literal notranslate"><span class="pre">coreneuron</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">linux</span> <span class="mi">3</span><span class="o">*</span> <span class="n">coreneuron</span>
</pre></div>
</div>
<p>Where we are passing <code class="docutils literal notranslate"><span class="pre">3*</span></code> to build the wheels with <code class="docutils literal notranslate"><span class="pre">CoreNEURON</span></code> support for all python 3 versions.</p>
</section>
<section id="macos">
<h3>macOS<a class="headerlink" href="#macos" title="Link to this heading"></a></h3>
<p>As mentioned above, for macOS all dependencies have to be available on a system. You have to then clone NEURON repository and execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">nrn</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">osx</span>
</pre></div>
</div>
<p>In some cases, setuptools-scm will see extra commits and consider your build as “dirty,” resulting in filenames such as <code class="docutils literal notranslate"><span class="pre">NEURON-9.0a1.dev0+g9a96a3a4d.d20230717-cp310-cp310-macosx_11_0_arm64.whl</span></code> (which should have been <code class="docutils literal notranslate"><span class="pre">NEURON-9.0a0-cp310-cp310-macosx_11_0_arm64.whl</span></code>). If this happens, you can set an environment variable to correct this behavior:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SETUPTOOLS_SCM_PRETEND_VERSION</span><span class="o">=</span><span class="mf">9.0</span><span class="n">a</span>
</pre></div>
</div>
<p>Change the pretend version to whatever is relevant for your case.</p>
</section>
</section>
<section id="testing-the-wheels">
<h2>Testing the wheels<a class="headerlink" href="#testing-the-wheels" title="Link to this heading"></a></h2>
<p>To test the generated wheels, you can do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># first arg is a python exe and second arg is the corresponding wheel</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">test_wheels</span><span class="o">.</span><span class="n">sh</span> <span class="n">python3</span><span class="mf">.8</span> <span class="n">wheelhouse</span><span class="o">/</span><span class="n">NEURON</span><span class="o">-</span><span class="mf">7.8.0.236</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">macosx_10_9_x86_64</span><span class="o">.</span><span class="n">whl</span>

<span class="c1"># Or, you can provide the pypi url</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">test_wheels</span><span class="o">.</span><span class="n">sh</span> <span class="n">python3</span><span class="mf">.8</span> <span class="s2">&quot;-i https://test.pypi.org/simple/NEURON==7.8.11.2&quot;</span>
</pre></div>
</div>
<section id="macos-considerations">
<h3>MacOS considerations<a class="headerlink" href="#macos-considerations" title="Link to this heading"></a></h3>
<p>On MacOS, launching <code class="docutils literal notranslate"><span class="pre">nrniv</span> <span class="pre">-python</span></code> or <code class="docutils literal notranslate"><span class="pre">special</span> <span class="pre">-python</span></code> can fail to load <code class="docutils literal notranslate"><span class="pre">neuron</span></code> module due to security restrictions.
For this specific purpose, please <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">SKIP_EMBEDED_PYTHON_TEST=true</span></code> before launching the tests.</p>
</section>
<section id="testing-on-bb5">
<h3>Testing on BB5<a class="headerlink" href="#testing-on-bb5" title="Link to this heading"></a></h3>
<p>On BB5, we can test CPU wheels with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">salloc</span> <span class="o">-</span><span class="n">A</span> <span class="n">proj16</span>  <span class="o">-</span><span class="n">N</span> <span class="mi">1</span> <span class="o">--</span><span class="n">ntasks</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">node</span><span class="o">=</span><span class="mi">4</span> <span class="o">-</span><span class="n">C</span> <span class="s2">&quot;cpu&quot;</span> <span class="o">--</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span><span class="n">p</span> <span class="n">interactive</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">unstable</span> <span class="n">python</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">test_wheels</span><span class="o">.</span><span class="n">sh</span> <span class="n">python3</span><span class="mf">.8</span> <span class="n">wheelhouse</span><span class="o">/</span><span class="n">NEURON</span><span class="o">-</span><span class="mf">7.8.0.236</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">cp38m</span><span class="o">-</span><span class="n">manylinux1_x86_64</span><span class="o">.</span><span class="n">whl</span>
</pre></div>
</div>
</section>
</section>
<section id="publishing-the-wheels-on-pypi-via-azure">
<h2>Publishing the wheels on Pypi via Azure<a class="headerlink" href="#publishing-the-wheels-on-pypi-via-azure" title="Link to this heading"></a></h2>
<section id="variables-that-drive-pypi-upload">
<h3>Variables that drive PyPI upload<a class="headerlink" href="#variables-that-drive-pypi-upload" title="Link to this heading"></a></h3>
<p>We need to manipulate the following three predefined variables, listed hereafter with their default values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NRN_NIGHTLY_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">true</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">false</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NEURON_NIGHTLY_TAG</span></code> : <code class="docutils literal notranslate"><span class="pre">-nightly</span></code></p></li>
</ul>
</section>
<section id="release-wheels">
<h3>Release wheels<a class="headerlink" href="#release-wheels" title="Link to this heading"></a></h3>
<p>Head over to the <a class="reference external" href="https://dev.azure.com/neuronsimulator/nrn/_build?definitionId=1">neuronsimulator.nrn</a> pipeline on Azure.</p>
<p>After creating the tag on the <code class="docutils literal notranslate"><span class="pre">release/x.y</span></code> or on the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch, perform the following steps:</p>
<ol class="arabic">
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">pipeline</span></code></p></li>
<li><p>Input the release tag ref <code class="docutils literal notranslate"><span class="pre">refs/tags/x.y.z</span></code></p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Advanced</span> <span class="pre">options</span></code> then select <code class="docutils literal notranslate"><span class="pre">Variables</span></code></p></li>
<li><p>Update driving variables to:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NRN_NIGHTLY_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">false</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">false</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NEURON_NIGHTLY_TAG</span></code> : undefined (leave empty)</p></li>
</ul>
<p>Do so by clicking <code class="docutils literal notranslate"><span class="pre">Variables</span></code> in <code class="docutils literal notranslate"><span class="pre">Advanced</span> <span class="pre">options</span></code> and update/clear the variable values.</p>
</li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Run</span></code></p></li>
</ol>
<p><img alt="" src="../_images/azure-release-no-upload.png" /></p>
<p>With above, wheel will be created like release from the provided tag but they won’t be uploaded to the pypi.org ( as we have set  <code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD=false</span></code>). These wheels now you can download from artifacts section and perform thorough testing. Once you are happy with the testing result, set <code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> and trigger the pipeline same way:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NRN_NIGHTLY_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">false</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">true</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NEURON_NIGHTLY_TAG</span></code> : undefined (leave empty)</p></li>
</ul>
</section>
</section>
<section id="publishing-the-wheels-on-pypi-via-circleci">
<h2>Publishing the wheels on Pypi via CircleCI<a class="headerlink" href="#publishing-the-wheels-on-pypi-via-circleci" title="Link to this heading"></a></h2>
<p>Currently CircleCI doesn’t have automated pipeline for uploading <code class="docutils literal notranslate"><span class="pre">release</span></code> wheels to pypi.org (nightly wheels are uploaded automatically though). Currently we are using a <strong>hacky</strong>, semi-automated approach described below:</p>
<ul class="simple">
<li><p>Checkout your tag as a new branch</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">.circleci/config.yml</span></code> as shown below</p></li>
<li><p>Trigger CI pipeline manually for <a class="reference external" href="https://app.circleci.com/pipelines/github/neuronsimulator/nrn">the nrn project</a></p></li>
<li><p>Upload wheels from artifacts manually</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># checkout release tag as a new branch
$ git checkout 8.1a -b release/8.1a-aarch64

# manually updated `.circleci/config.yml`
$ git diff

@@ -15,6 +15,10 @@ jobs:
     machine:
       image: ubuntu-2004:202101-01
+    environment:
+      SETUPTOOLS_SCM_PRETEND_VERSION: 8.1a
+      NEURON_NIGHTLY_TAG: &quot;&quot;
+      NRN_NIGHTLY_UPLOAD: false
+      NRN_RELEASE_UPLOAD: false

@@ -89,7 +95,7 @@ workflows:
       - manylinux2014-aarch64:
           matrix:
             parameters:
-              NRN_PYTHON_VERSION: [&quot;311&quot;]
+              NRN_PYTHON_VERSION: [&quot;38&quot;, &quot;39&quot;, &quot;310&quot;, &quot;311&quot;]
</pre></div>
</div>
<p>The reason we are setting <code class="docutils literal notranslate"><span class="pre">SETUPTOOLS_SCM_PRETEND_VERSION</span></code> to a desired version <code class="docutils literal notranslate"><span class="pre">8.1a</span></code> because <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> uses <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">describe</span></code> and it will give different version name as we are now on a new branch!</p>
</section>
<section id="nightly-wheels">
<h2>Nightly wheels<a class="headerlink" href="#nightly-wheels" title="Link to this heading"></a></h2>
<p>Nightly wheels get automatically published from <code class="docutils literal notranslate"><span class="pre">master</span></code> in CRON mode.</p>
</section>
<section id="how-to-test-azure-wheels-locally">
<h2>How to test Azure wheels locally<a class="headerlink" href="#how-to-test-azure-wheels-locally" title="Link to this heading"></a></h2>
<p>After retrieving the Azure drop URL (i.e. from the GitHub PR comment, or by going to Azure for a specific build):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>wheel<span class="w"> </span>neuron-gpu-nightly<span class="w"> </span>--wheel-dir<span class="w"> </span>tmp<span class="w"> </span>--find-links<span class="w"> </span><span class="s1">&#39;https://dev.azure.com/neuronsimulator/aa1fb98d-a914-45c3-a215-5e5ef1bd7687/_apis/build/builds/7600/artifacts?artifactName=drop&amp;api-version=7.0&amp;%24format=zip&#39;</span>
</pre></div>
</div>
<p>will download the wheel and its dependencies to <code class="docutils literal notranslate"><span class="pre">tmp/</span></code> and then you can test it with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./packaging/python/test_wheels.sh<span class="w"> </span>python3<span class="w"> </span>./tmp/NEURON_gpu_nightly-...whl<span class="w"> </span><span class="nb">true</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mac_pkg.html" class="btn btn-neutral float-left" title="Mac Binary Package (Apple M1 and Mac x86_64)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="windows.html" class="btn btn-neutral float-right" title="Windows build" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Duke, Yale and the Blue Brain Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>